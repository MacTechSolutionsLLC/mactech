'use client'

import { useState, useEffect } from 'react'
import { FormBuilder, FormField } from '@/components/tools/FormBuilder'
import DataTable from '@/components/tools/DataTable'
import StatusBadge from '@/components/tools/StatusBadge'

export default function VulnerabilityCompliance() {
  const [analyses, setAnalyses] = useState<any[]>([])
  const [selectedAnalysis, setSelectedAnalysis] = useState<any>(null)
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    loadAnalyses()
  }, [])

  const loadAnalyses = async () => {
    try {
      const response = await fetch('/api/tools/vulnerability-compliance')
      const data = await response.json()
      if (data.success) {
        setAnalyses(data.data || [])
      }
    } catch (err) {
      console.error('Failed to load analyses:', err)
    }
  }

  const handleAnalyzeCVE = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    setLoading(true)
    const formData = new FormData(e.currentTarget)
    const analysisData = {
      softwareName: formData.get('softwareName'),
      version: formData.get('version'),
      vendor: formData.get('vendor'),
    }
    try {
      const response = await fetch('/api/tools/vulnerability-compliance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(analysisData),
      })
      const data = await response.json()
      if (data.success) {
        await loadAnalyses()
        setSelectedAnalysis(data.data)
        e.currentTarget.reset()
      }
    } catch (err) {
      console.error('Failed to analyze CVE:', err)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="space-y-8">
      <div>
        <h2 className="heading-3 mb-4">Analyze CVE</h2>
        <div className="bg-white rounded-lg border border-neutral-200 p-6">
          <FormBuilder onSubmit={handleAnalyzeCVE} submitLabel="Analyze" isLoading={loading}>
            <FormField
              label="Software Name"
              name="softwareName"
              type="text"
              placeholder="Apache HTTP Server"
              required
            />
            <FormField
              label="Version"
              name="version"
              type="text"
              placeholder="2.4.41"
              required
            />
            <FormField
              label="Vendor"
              name="vendor"
              type="text"
              placeholder="Apache Software Foundation"
            />
          </FormBuilder>
        </div>
      </div>

      <div>
        <h2 className="heading-3 mb-4">CVE Analyses</h2>
        <DataTable
          data={analyses}
          columns={[
            { key: 'softwareName', header: 'Software' },
            { key: 'version', header: 'Version' },
            {
              key: 'riskLevel',
              header: 'Risk Level',
              render: (item) => (
                <StatusBadge
                  status={
                    item.riskLevel === 'low' ? 'success' :
                    item.riskLevel === 'medium' ? 'warning' :
                    item.riskLevel === 'high' ? 'error' : 'error'
                  }
                >
                  {item.riskLevel}
                </StatusBadge>
              ),
            },
            {
              key: 'status',
              header: 'Status',
              render: (item) => (
                <StatusBadge
                  status={
                    item.status === 'completed' ? 'success' :
                    item.status === 'analyzing' ? 'warning' : 'pending'
                  }
                >
                  {item.status}
                </StatusBadge>
              ),
            },
            {
              key: 'actions',
              header: 'Actions',
              render: (item) => (
                <button
                  onClick={() => setSelectedAnalysis(item)}
                  className="text-body-sm text-blue-600 hover:text-blue-800"
                >
                  View Details
                </button>
              ),
            },
          ]}
          emptyMessage="No CVE analyses found. Analyze your first software above."
        />
      </div>

      {selectedAnalysis && selectedAnalysis.cves && (
        <div>
          <h2 className="heading-3 mb-4">CVE Details</h2>
          <div className="bg-white rounded-lg border border-neutral-200 p-6">
            <div className="mb-4">
              <StatusBadge
                status={
                  selectedAnalysis.riskLevel === 'low' ? 'success' :
                  selectedAnalysis.riskLevel === 'medium' ? 'warning' :
                  selectedAnalysis.riskLevel === 'high' ? 'error' : 'error'
                }
              >
                Risk Level: {selectedAnalysis.riskLevel}
              </StatusBadge>
            </div>
            <DataTable
              data={selectedAnalysis.cves}
              columns={[
                { key: 'id', header: 'CVE ID' },
                { key: 'title', header: 'Title' },
                {
                  key: 'severity',
                  header: 'Severity',
                  render: (item) => (
                    <StatusBadge
                      status={
                        item.severity === 'low' ? 'success' :
                        item.severity === 'medium' ? 'warning' :
                        item.severity === 'high' ? 'error' : 'error'
                      }
                    >
                      {item.severity}
                    </StatusBadge>
                  ),
                },
                { key: 'cvssScore', header: 'CVSS Score' },
                { key: 'remediation', header: 'Remediation' },
              ]}
            />
          </div>
        </div>
      )}
    </div>
  )
}

