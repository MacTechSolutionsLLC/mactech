// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Authentication User model
model User {
  id                               String    @id @default(cuid())
  email                            String    @unique
  name                             String?
  password                         String? // Encrypted password (bcrypt hash)
  role                             String    @default("USER") // USER, ADMIN
  image                            String?
  emailVerified                    DateTime?
  mustChangePassword               Boolean   @default(false) // Force password change on next login
  lastLoginAt                      DateTime? // Last successful login timestamp
  disabled                         Boolean   @default(false) // Account disabled flag
  securityAcknowledgmentVersion    String? // Version of security acknowledgment accepted
  securityAcknowledgmentAcceptedAt DateTime? // When security acknowledgment was accepted
  securityAcknowledgmentRequired   Boolean   @default(true) // Whether acknowledgment is required
  // MFA fields (CMMC Level 2)
  mfaEnabled                       Boolean   @default(false) // Whether MFA is enabled for this user
  mfaSecret                        String? // Encrypted TOTP secret
  mfaBackupCodes                   String? // JSON array of hashed backup codes
  mfaEnrolledAt                    DateTime? // When MFA was enrolled
  // Account lockout fields (CMMC Level 2)
  failedLoginAttempts              Int       @default(0) // Number of consecutive failed login attempts
  lockedUntil                      DateTime? // Account lockout expiration timestamp
  createdAt                        DateTime  @default(now())
  updatedAt                        DateTime  @updatedAt

  // Relations
  events             AppEvent[] // Events created by this user
  uploadedFiles      StoredFile[] // Files uploaded by this user
  uploadedCUIFiles   StoredCUIFile[] @relation("CUIFiles") // CUI files uploaded by this user
  physicalAccessLogs PhysicalAccessLog[] // Physical access logs created by this user
  passwordHistory    PasswordHistory[] // Password history for reuse prevention

  @@index([email])
  @@index([disabled])
  @@index([lastLoginAt])
}

// Password history for reuse prevention (NIST SP 800-171 Rev. 2, Section 3.5.8)
model PasswordHistory {
  id        String   @id @default(cuid())
  userId    String
  passwordHash String // bcrypt hash of password
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

model ReadinessAssessment {
  id               String   @id @default(cuid())
  email            String
  name             String?
  organization     String?
  systemType       String
  authStatus       String
  auditHistory     String
  infraMaturity    String
  timelinePressure String
  readinessScore   String
  gapsSummary      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model ContactSubmission {
  id           String   @id @default(cuid())
  name         String
  email        String
  organization String?
  phone        String?
  message      String
  createdAt    DateTime @default(now())
}

model GovernmentContractDiscovery {
  id                    String    @id @default(cuid())
  google_query          String
  service_category      String?
  title                 String
  url                   String    @unique
  domain                String
  snippet               String?
  document_type         String?
  notice_id             String?
  solicitation_number   String?
  agency                String?
  naics_codes           String    @default("[]") // JSON array as string
  set_aside             String    @default("[]") // JSON array as string
  location_mentions     String    @default("[]") // JSON array as string
  detected_keywords     String    @default("[]") // JSON array as string
  relevance_score       Int       @default(0)
  ingestion_status      String    @default("discovered")
  verified              Boolean   @default(false)
  verified_at           DateTime?
  verified_by           String?
  downloaded            Boolean   @default(false)
  downloaded_at         DateTime?
  proposal_generated    Boolean   @default(false)
  proposal_generated_at DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  discovered_by         String?

  // Ingestion pipeline fields
  ingestion_source   String? // Track if from ingestion pipeline vs search
  ingestion_batch_id String? // Track ingestion batch (batchId)
  flagged            Boolean   @default(false)
  flagged_at         DateTime?
  flagged_by         String?
  ignored            Boolean   @default(false) // Track if ignored

  // New ingestion fields per specification
  raw_payload       String? // JSON string of raw SAM.gov API response
  normalized_fields String? // JSON string of normalized opportunity data
  source_queries    String    @default("[]") // JSON array of source query identifiers (A, B, C, D, E)
  ingested_at       DateTime? // When this opportunity was ingested

  // Scraping fields
  scraped              Boolean   @default(false)
  scraped_at           DateTime?
  scraped_html_content String? // Full HTML content of opportunity page
  scraped_text_content String? // Extracted text from HTML

  // SOW attachment fields
  sow_attachment_url     String? // URL to the SOW attachment
  sow_attachment_type    String? // PDF, DOCX, etc.
  sow_attachment_content String? // Extracted text from SOW document
  sow_scraped            Boolean   @default(false)
  sow_scraped_at         DateTime?

  // Analysis fields
  analysis_summary    String? // AI/heuristic analysis of the contract
  analysis_confidence Float? // Confidence score 0-1
  analysis_keywords   String  @default("[]") // Additional keywords from analysis

  // AI Parsing fields
  aiParsedData String? // JSON string of parsed contract data
  aiParsedAt   DateTime?

  // AI Analysis fields
  aiSummary             String? // AI-generated executive summary
  aiKeyRequirements     String? // JSON array of key requirements
  aiKeywords            String? // JSON array of AI-detected keywords
  aiStrengths           String? // JSON array of strengths/advantages
  aiConcerns            String? // JSON array of concerns/challenges
  aiFitScore            Float? // 0-100 fit score for MacTech capabilities
  aiServiceCategory     String? // cybersecurity, infrastructure, compliance, contracts, general
  aiRecommendedActions  String? // JSON array of recommended actions
  aiAnalysisGeneratedAt DateTime?
  aiAnalysis            String? // JSON string of complete AI analysis (relevanceSummary, recommendedAction, capabilityMatch, risks)

  // AI Award Likelihood fields
  aiAwardLikelihood            Float? // 0-100 award probability score
  aiAwardConfidence            String? // HIGH, MEDIUM, LOW
  aiAwardReasoning             String? // Explanation of the score
  aiAwardStrengths             String? // JSON array of award strengths
  aiAwardConcerns              String? // JSON array of award concerns
  aiAwardRiskFactors           String? // JSON array of risk factors
  aiAwardRecommendations       String? // JSON array of recommendations
  aiAwardLikelihoodGeneratedAt DateTime?

  // Dismissal fields
  dismissed        Boolean   @default(false)
  dismissed_at     DateTime?
  dismissed_by     String?
  dismissal_reason String?

  // Additional contract details
  points_of_contact     String? // JSON array of POC objects: [{name, email, phone, role}]
  description           String? // Full contract description
  requirements          String? // JSON array of requirements
  deadline              String? // Response deadline/date
  estimated_value       String? // Contract value estimate
  period_of_performance String? // POP dates
  place_of_performance  String? // Location/place of performance
  resource_links        String? // JSON array of all links: [{url, type, name, description}]

  // USAspending enrichment fields
  usaspending_enrichment        String?   @db.Text // JSON field to store enrichment data and AI analysis
  usaspending_enriched_at       DateTime? // Timestamp of when enrichment was performed
  usaspending_enrichment_status String? // Status: 'pending', 'completed', 'failed'

  // Capture dashboard fields
  incumbent_vendors             String? @db.Text // JSON array of likely incumbents from USAspending
  competitive_landscape_summary String? @db.Text // AI-generated competitive landscape summary
  capture_status                String? // 'flagged', 'monitoring', 'ignored', 'pursuing'

  // Smart Sort fields (optional caching)
  smart_sort_score         Float? // 0-100 composite score for AI-enhanced sorting
  smart_sort_reasoning     String?   @db.Text // AI reasoning for the smart sort score
  smart_sort_calculated_at DateTime? // When smart sort was last calculated

  // Capability matching fields
  capability_match_score         Float? // 0-100 overall capability match score
  matched_resume_skills          String?   @db.Text // JSON array of matched skills from leadership resumes
  matched_services               String?   @db.Text // JSON array of matched service IDs/names
  matched_showcases              String?   @db.Text // JSON array of matched tool/platform IDs/names
  primary_pillar                 String? // Security, Infrastructure, Quality, Governance
  capability_match_breakdown     String?   @db.Text // JSON breakdown of match scores by category
  capability_match_calculated_at DateTime? // When capability match was last calculated

  // Unified Pipeline Status fields
  pipeline_status       String    @default("discovered") // discovered, scraping, scraped, enriching, enriched, analyzing, analyzed, ready, flagged, ignored
  pipeline_stage        String? // Current stage identifier
  pipeline_errors       String    @default("[]") // JSON array of errors encountered
  auto_processed        Boolean   @default(false) // Whether auto-processing was attempted
  pipeline_started_at   DateTime? // When pipeline processing started
  pipeline_completed_at DateTime? // When pipeline processing completed

  // Intelligence fields
  opportunity_fingerprint        String?   @unique // SHA256 hash for deduplication
  lifecycle_stage_classification String? // 'SOURCES_SOUGHT' | 'PRE_SOLICITATION' | 'SOLICITATION' | 'AWARD' | 'UNKNOWN'
  agency_behavior_profile        String?   @db.Text // JSON: new_vendor_acceptance_rate, typical_award_size_avg, etc.
  incumbent_concentration_score  Float? // 0-1 HHI score
  award_size_realism_ratio       Float? // SAM value / historical average
  recompete_likelihood           Float? // 0-1 probability
  set_aside_enforcement_reality  String?   @db.Text // JSON: compliance_rate, enforcement_strength
  intelligence_data              String?   @db.Text // JSON: complete intelligence payload
  intelligence_calculated_at     DateTime?

  // Relationships
  awardLinks OpportunityAwardLink[]

  @@index([opportunity_fingerprint])
  @@index([lifecycle_stage_classification])
  @@index([incumbent_concentration_score])
  @@index([recompete_likelihood])
}

// Ignored opportunities from ingestion pipeline
model IgnoredOpportunity {
  id         String   @id @default(cuid())
  notice_id  String   @unique
  ignored_at DateTime @default(now())
  ignored_by String?
  reason     String?

  @@index([notice_id])
}

// ============================================================================
// Federal Capture Dashboard Models
// ============================================================================

// Links between SAM.gov opportunities and USAspending awards
// Enables deterministic joins for competitive intelligence
model OpportunityAwardLink {
  id             String @id @default(cuid())
  opportunity_id String // GovernmentContractDiscovery ID
  award_id       String // UsaSpendingAward ID

  // Join metadata
  join_confidence  Float? // 0-1 confidence in the match
  join_method      String? // 'agency_naics', 'title_similarity', 'manual'
  similarity_score Float? // Title similarity score if applicable

  // Match criteria used
  matched_naics    String? // JSON array of matched NAICS codes
  matched_agency   String? // Matched agency name/ID
  title_similarity Float? // Cosine similarity score

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relationships
  opportunity GovernmentContractDiscovery? @relation(fields: [opportunity_id], references: [id], onDelete: Cascade)
  award       UsaSpendingAward?            @relation(fields: [award_id], references: [id], onDelete: Cascade)

  @@unique([opportunity_id, award_id])
  @@index([opportunity_id])
  @@index([award_id])
  @@index([join_confidence])
}

// Track ingestion runs and SAM.gov outage states
model IngestionStatus {
  id String @id @default(cuid())

  // Status tracking
  status   String // 'running', 'completed', 'paused', 'failed', 'outage'
  batch_id String? // Current or last batch ID

  // SAM.gov outage detection
  sam_gov_outage             Boolean   @default(false)
  sam_gov_outage_detected_at DateTime?
  sam_gov_outage_resolved_at DateTime?
  sam_gov_outage_reason      String? // e.g., 'State: SUSPENDED'

  // Ingestion metrics
  last_run_started_at   DateTime?
  last_run_completed_at DateTime?
  last_run_duration_ms  Int? // Duration in milliseconds

  // Last run results
  last_fetched         Int @default(0)
  last_deduplicated    Int @default(0)
  last_passed_filters  Int @default(0)
  last_scored_above_50 Int @default(0)

  // Error tracking
  last_error  String? @db.Text
  error_count Int     @default(0)

  // Retry tracking
  retry_count   Int       @default(0)
  next_retry_at DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([status])
  @@index([sam_gov_outage])
  @@index([last_run_started_at])
}

// ============================================================================
// Intelligence Cache Models
// Cached intelligence data for agencies and vendors
// ============================================================================

// Agency intelligence cache (composite key: agency_id + naics_code)
model AgencyIntelligenceCache {
  id                  String   @id @default(cuid())
  agency_id           String // Normalized agency identifier
  agency_name         String
  naics_code          String
  behavior_profile    String   @db.Text // JSON: agency_behavior_profile structure
  last_calculated_at  DateTime @default(now())
  award_count         Int // Number of awards used in calculation
  calculation_version Int      @default(1) // For cache invalidation

  @@unique([agency_id, naics_code], name: "agency_id_naics_code")
  @@index([agency_id])
  @@index([naics_code])
  @@index([last_calculated_at])
}

// Vendor intelligence cache (composite key: vendor_uei + agency_id + naics_code)
model VendorIntelligenceCache {
  id                       String   @id @default(cuid())
  vendor_uei               String
  vendor_name              String
  agency_id                String
  naics_code               String
  market_share             Float // 0-1: wins / total awards
  total_awards             Int
  total_obligation         Float
  capability_fingerprint   String   @db.Text // JSON: {naics: [], psc: []}
  certification_advantages String   @db.Text // JSON: ['SDVOSB', 'VOSB', etc.]
  last_calculated_at       DateTime @default(now())
  calculation_version      Int      @default(1)

  @@unique([vendor_uei, agency_id, naics_code], name: "vendor_uei_agency_id_naics_code")
  @@index([vendor_uei])
  @@index([agency_id])
  @@index([naics_code])
  @@index([market_share])
}

// ============================================================================
// USAspending.gov Historical Awards
// Models for storing historical award data from USAspending.gov
// ============================================================================

model UsaSpendingAward {
  id                        String  @id @default(cuid())
  award_id                  String? @unique // USAspending award ID
  generated_unique_award_id String? @unique // Generated unique award ID

  // Award type and category
  award_type             String? // A, B, C, D, IDV, etc.
  award_type_description String?
  category               String? // contract, grant, loan, etc.

  // Award identifiers
  piid String? // Procurement Instrument Identifier
  fain String? // Federal Award Identification Number
  uri  String? // Unique Record Identifier

  // Financial data
  total_obligation   Float?
  total_outlay       Float?
  total_subsidy_cost Float?

  // Agency information (stored as JSON for flexibility)
  awarding_agency      String? // JSON: {id, name, toptier_agency, subtier_agency}
  funding_agency       String? // JSON: {id, name, toptier_agency, subtier_agency}
  awarding_agency_name String? // Denormalized for easy querying
  funding_agency_name  String? // Denormalized for easy querying
  awarding_agency_id   String? // Denormalized for easy querying
  funding_agency_id    String? // Denormalized for easy querying

  // Recipient information
  recipient_name     String?
  recipient_uei      String?
  recipient_duns     String?
  recipient_hash     String?
  recipient_id       String?
  recipient_location String? // JSON: {address, city, state, zip, country, congressional_district}

  // Place of performance
  place_of_performance String? // JSON: {state, county, city, zip, country, congressional_district, location}
  pop_state            String? // Denormalized for easy querying
  pop_country          String? // Denormalized for easy querying

  // Dates
  start_date            DateTime?
  end_date              DateTime?
  last_modified_date    DateTime?
  awarding_date         DateTime?
  period_of_performance String? // JSON: {start_date, end_date, last_modified_date}

  // Classification codes
  naics_code        String?
  naics_description String?
  psc_code          String?
  psc_description   String?
  cfda_number       String?
  cfda_title        String?

  // Description
  description String? @db.Text

  // Counts
  transaction_count     Int    @default(0)
  total_subaward_amount Float?
  subaward_count        Int    @default(0)

  // Raw data and metadata
  raw_data           String?  @db.Text // Full API response as JSON
  ingested_at        DateTime @default(now())
  updated_at         DateTime @updatedAt
  ingestion_batch_id String?

  // SAM.gov Entity API enrichment (vendor metadata)
  recipient_entity_data String? @db.Text // JSON: enriched vendor data from Entity API (UEI, NAICS, certifications, etc.)

  // Capture intelligence fields
  relevance_score       Float? // Capture relevance score (0â€“100)
  signals               String? // JSON array of signal labels
  enrichment_status     String? // 'pending' | 'completed' | 'failed'
  enriched_at           DateTime?
  human_award_id        String? // Human-readable identifier (e.g. "HC102819F0141")
  generated_internal_id String?   @unique // TRUE API primary key (must be unique)

  // Relationships
  transactions     UsaSpendingTransaction[]
  opportunityLinks OpportunityAwardLink[]

  // Indexes for common queries
  @@index([award_id])
  @@index([award_type])
  @@index([awarding_agency_id])
  @@index([funding_agency_id])
  @@index([recipient_uei])
  @@index([recipient_duns])
  @@index([naics_code])
  @@index([psc_code])
  @@index([pop_state])
  @@index([awarding_date])
  @@index([start_date])
  @@index([end_date])
  @@index([ingested_at])
}

model UsaSpendingTransaction {
  id             String  @id @default(cuid())
  transaction_id String? @unique
  award_id       String? // Link to UsaSpendingAward

  // Transaction details
  action_date               DateTime?
  action_type               String?
  action_type_description   String?
  federal_action_obligation Float?
  total_obligation          Float?
  total_outlay              Float?

  // Agency information
  awarding_agency      String? // JSON
  funding_agency       String? // JSON
  awarding_agency_name String? // Denormalized
  funding_agency_name  String? // Denormalized

  // Recipient information
  recipient      String? // JSON
  recipient_name String?
  recipient_uei  String?
  recipient_duns String?

  // Raw data
  raw_data    String?  @db.Text // Full API response as JSON
  ingested_at DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relationships
  award UsaSpendingAward? @relation(fields: [award_id], references: [id], onDelete: Cascade)

  @@index([transaction_id])
  @@index([award_id])
  @@index([action_date])
  @@index([recipient_uei])
  @@index([recipient_duns])
}

// ============================================================================
// MacTech Platforms Database Schema
// Models for automation platforms and tools
// ============================================================================

// Infrastructure Domain
model Deployment {
  id            String    @id @default(uuid())
  name          String
  architecture  String
  storageType   String
  status        String
  systemId      String?
  vmwareConfig  String? // JSON
  networkConfig String? // JSON
  compliance    String? // JSON
  metadata      String? // JSON
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deployedAt    DateTime?

  @@index([systemId])
  @@index([status])
}

model SystemHealth {
  id          String   @id @default(uuid())
  systemId    String   @unique
  systemName  String
  systemType  String
  status      String
  metrics     String? // JSON
  alerts      String? // JSON
  lastUpdated DateTime @default(now())

  @@index([status])
  @@index([systemType])
}

model NetworkTopology {
  id           String   @id @default(uuid())
  name         String
  description  String?
  zones        String // JSON array
  requirements String? // JSON
  status       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status])
}

model FirewallRule {
  id          String   @id @default(uuid())
  topologyId  String
  source      String
  destination String
  port        String
  protocol    String
  action      String
  description String
  createdAt   DateTime @default(now())

  @@index([topologyId])
}

// Quality Assurance Domain
model ISOComplianceProgram {
  id             String   @id @default(uuid())
  organizationId String
  standard       String
  scope          String
  status         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([standard])
}

model SOP {
  id          String    @id @default(uuid())
  title       String
  requirement String
  standard    String?
  version     String
  status      String
  content     String
  format      String
  metadata    String? // JSON
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  approvedAt  DateTime?

  @@index([status])
  @@index([standard])
}

model MetrologyProject {
  id          String    @id @default(uuid())
  projectName String
  equipmentId String?
  status      String
  dueDate     DateTime?
  metadata    String? // JSON
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([equipmentId])
  @@index([status])
}

model ComplianceGap {
  id            String   @id @default(uuid())
  programId     String
  requirement   String
  clause        String
  currentStatus String
  remediation   String
  priority      String?
  createdAt     DateTime @default(now())

  @@index([programId])
}

model AuditReadiness {
  id              String    @id @default(uuid())
  systemId        String
  auditType       String
  auditDate       DateTime?
  readinessScore  Int
  readinessLevel  String
  gaps            String // JSON array
  strengths       String // JSON array
  recommendations String // JSON array
  metadata        String? // JSON
  status          String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([systemId])
  @@index([auditType])
  @@index([status])
}

model AuditEvidencePackage {
  id          String    @id @default(uuid())
  auditId     String
  evidence    String // JSON array
  status      String
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([auditId])
  @@index([status])
}

// Legal & Contracts Domain
model Contract {
  id        String    @id @default(uuid())
  title     String
  type      String
  status    String
  riskScore Int?
  startDate DateTime
  endDate   DateTime?
  metadata  String? // JSON
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  signedAt  DateTime?
  expiresAt DateTime?

  @@index([status])
  @@index([type])
  @@index([expiresAt])
}

model LegalDocument {
  id           String    @id @default(uuid())
  documentType String
  title        String
  parties      String // JSON array
  terms        String? // JSON
  version      String
  status       String
  content      String
  format       String
  metadata     String? // JSON
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  approvedAt   DateTime?
  signedAt     DateTime?

  @@index([documentType])
  @@index([status])
}

model DocumentReview {
  id         String   @id @default(uuid())
  documentId String
  reviewer   String
  reviewDate DateTime @default(now())
  risks      String // JSON array
  status     String
  createdAt  DateTime @default(now())

  @@index([documentId])
  @@index([status])
}

model ContractObligation {
  id          String    @id @default(uuid())
  contractId  String
  description String
  type        String
  dueDate     DateTime
  status      String
  completedAt DateTime?

  @@index([contractId])
  @@index([status])
  @@index([dueDate])
}

// Cybersecurity & RMF Domain
model RMFRequirement {
  id                   String   @id @default(uuid())
  systemId             String
  controlId            String
  title                String
  implementationStatus String
  traceabilityId       String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([systemId])
  @@index([controlId])
  @@index([implementationStatus])
}

model BOEPlan {
  id           String   @id @default(uuid())
  systemId     String
  controlId    String
  evidenceType String
  status       String
  dueDate      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([systemId])
  @@index([controlId])
  @@index([status])
}

model SecurityBaseline {
  id         String    @id @default(uuid())
  name       String
  systemType String
  controls   String // JSON array
  status     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime?

  @@index([status])
  @@index([systemType])
}

model SecurityDocument {
  id           String    @id @default(uuid())
  documentType String
  systemId     String
  systemName   String
  title        String
  content      String
  format       String
  version      String
  status       String
  metadata     String? // JSON
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  approvedAt   DateTime?

  @@index([systemId])
  @@index([documentType])
  @@index([status])
}

model CVEAnalysis {
  id             String    @id @default(uuid())
  softwareName   String
  version        String
  status         String
  riskLevel      String
  recommendation String
  cves           String? // JSON array
  createdAt      DateTime  @default(now())
  completedAt    DateTime?

  @@index([status])
  @@index([riskLevel])
}

model VulnerabilityFinding {
  id          String   @id @default(uuid())
  scanId      String
  cveId       String?
  title       String
  severity    String
  status      String
  remediation String?
  createdAt   DateTime @default(now())

  @@index([scanId])
  @@index([severity])
  @@index([status])
}

model VulnerabilityScan {
  id          String    @id @default(uuid())
  systemId    String
  scanType    String
  status      String
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([systemId])
  @@index([status])
}

// Compliance & Security Domain
model STIGValidation {
  id          String    @id @default(uuid())
  systemId    String
  stigProfile String
  systemType  String
  status      String
  results     String? // JSON
  remediation String? // JSON
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([systemId])
  @@index([status])
}

model Evidence {
  id           String    @id @default(uuid())
  controlId    String
  systemId     String
  evidenceType String
  status       String
  qualityScore Int?
  collectedAt  DateTime?
  validatedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([systemId])
  @@index([controlId])
  @@index([status])
}

model RMFArtifact {
  id           String    @id @default(uuid())
  artifactType String
  systemId     String
  systemName   String
  content      String
  status       String
  qualityScore Int?
  metadata     String? // JSON
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  approvedAt   DateTime?

  @@index([systemId])
  @@index([artifactType])
  @@index([status])
}

// Support Automation Domain
model Ticket {
  id          String    @id @default(uuid())
  title       String
  description String
  category    String?
  priority    String
  status      String
  requester   String
  assignedTo  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  resolvedAt  DateTime?
  slaDeadline DateTime?

  @@index([status])
  @@index([priority])
  @@index([assignedTo])
}

model KnowledgeArticle {
  id           String    @id @default(uuid())
  title        String
  content      String
  category     String?
  status       String
  views        Int       @default(0)
  helpful      Int       @default(0)
  notHelpful   Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastViewedAt DateTime?

  @@index([status])
  @@index([category])
}

// Team Leadership Domain
model TeamMember {
  id               String   @id @default(uuid())
  name             String
  email            String   @unique
  role             String
  performanceScore Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([role])
}

model PerformanceReview {
  id            String   @id @default(uuid())
  teamMemberId  String
  reviewDate    DateTime @default(now())
  reviewer      String
  overallRating String
  reviewData    String? // JSON
  createdAt     DateTime @default(now())

  @@index([teamMemberId])
  @@index([reviewDate])
}

// ============================================================================
// CMMC Level 1 Compliance Models
// ============================================================================

// Application event logging for audit trail
model AppEvent {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  actorUserId String? // User ID who performed the action
  actorEmail  String? // User email (denormalized for easier querying)
  actionType  String // login, logout, user_create, user_disable, file_upload, file_download, admin_action, etc.
  targetType  String? // Type of target (user, file, contract, etc.)
  targetId    String? // ID of target entity
  ip          String? // IP address of request
  userAgent   String? // User agent string
  success     Boolean  @default(true) // Whether action succeeded
  details     String?  @db.Text // JSON string with additional details

  // Relations
  actor User? @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([timestamp])
  @@index([actorUserId])
  @@index([actionType])
  @@index([targetType, targetId])
  @@index([success])
}

// Stored files (replaces /public/uploads) - FCI files only
model StoredFile {
  id                 String    @id @default(cuid())
  userId             String // User who uploaded the file
  filename           String // Original filename
  mimeType           String // MIME type
  size               Int // File size in bytes
  data               Bytes // File content (BYTEA in PostgreSQL)
  uploadedAt         DateTime  @default(now())
  deletedAt          DateTime? // Logical deletion timestamp
  signedUrlExpiresAt DateTime? // Expiration for signed URL
  metadata           String?   @db.Text // JSON metadata (non-sensitive)
  isFCI              Boolean   @default(false) // Flag to identify FCI files

  // Relations
  uploader User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([uploadedAt])
  @@index([deletedAt])
  @@index([isFCI])
}

// CUI files - stored separately with password protection
model StoredCUIFile {
  id                 String    @id @default(cuid())
  userId             String // User who uploaded the file
  filename           String // Original filename
  mimeType           String // MIME type
  size               Int // File size in bytes
  data               Bytes // File content (BYTEA in PostgreSQL)
  uploadedAt         DateTime  @default(now())
  deletedAt          DateTime? // Logical deletion timestamp
  signedUrlExpiresAt DateTime? // Expiration for signed URL
  metadata           String?   @db.Text // JSON metadata (non-sensitive)

  // Relations
  uploader User @relation("CUIFiles", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([uploadedAt])
  @@index([deletedAt])
}

// Public content approval (for public release control)
model PublicContent {
  id          String    @id @default(cuid())
  content     String    @db.Text // Content to be made public
  contentType String // Type of content (post, page, etc.)
  approvedBy  String? // User ID who approved
  approvedAt  DateTime? // When approved
  isPublic    Boolean   @default(false) // Whether content is public
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isPublic])
  @@index([approvedAt])
}

// Physical access logs for PE.L1-3.10.4 compliance
// Immutable after creation (tamper-evident)
model PhysicalAccessLog {
  id              String   @id @default(cuid())
  date            DateTime // Date of access
  timeIn          String // Time in (HH:mm format)
  timeOut         String? // Time out (HH:mm format, optional)
  personName      String // Name of person accessing
  purpose         String // Purpose of access
  hostEscort      String? // Host/escort name (optional)
  location        String // Location identifier (e.g., "Home Office", "Workstation Area")
  notes           String?  @db.Text // Additional notes
  createdAt       DateTime @default(now()) // Immutable creation timestamp
  createdByUserId String // User who created the entry (immutable)

  // Relations
  createdBy User @relation(fields: [createdByUserId], references: [id], onDelete: Restrict)

  @@index([date])
  @@index([location])
  @@index([createdAt])
  @@index([createdByUserId])
}

// Endpoint inventory for SI.L1-3.14.2 malware protection compliance
model EndpointInventory {
  id                 String    @id @default(cuid())
  deviceIdentifier   String // Device identifier (hostname, serial number, etc.)
  owner              String // Device owner name
  os                 String // Operating system
  avEnabled          Boolean   @default(false) // Antivirus enabled (yes/no)
  lastVerifiedDate   DateTime? // Last verification date
  verificationMethod String? // Verification method (e.g., "Screenshot", "EDR Dashboard", "Defender UI")
  notes              String?   @db.Text // Additional notes
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([deviceIdentifier])
  @@index([owner])
  @@index([lastVerifiedDate])
}

// Plan of Action and Milestones (POA&M) for CMMC Level 2 compliance
model POAMItem {
  id                   String    @id @default(cuid())
  poamId               String    @unique // e.g., "POAM-001"
  controlId            String // NIST control ID (e.g., "3.2.2")
  title                String
  description          String    @db.Text
  affectedControls     String    @db.Text // JSON array of control IDs
  status               String    @default("open") // "open" or "closed"
  priority             String    @default("medium") // "low", "medium", "high", "critical"
  responsibleParty     String
  targetCompletionDate DateTime?
  actualCompletionDate DateTime?
  plannedRemediation   String    @db.Text // JSON array of remediation steps
  milestones           String    @db.Text // JSON array of milestone objects
  notes                String?   @db.Text
  evidence             String?   @db.Text // Body of evidence for closed/verified POA&Ms
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  createdBy            String? // User ID who created it
  verifiedBy           String? // User ID who verified completion
  verifiedAt           DateTime?

  @@index([status])
  @@index([priority])
  @@index([controlId])
  @@index([poamId])
  @@index([targetCompletionDate])
}
